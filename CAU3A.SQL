CONN sys/123@//LOCALHOST:1523/ORCLDOCKER as sysdba; 
ALTER SESSION SET CURRENT_SCHEMA = QL_NHANSU ; 

-- CAU A 
-- CAP QUYEN CHO GIAM DOC;
GRANT SELECT ON NHANVIEN TO NV001;
GRANT SELECT ON LUONG TO NV001;
GRANT SELECT, INSERT, UPDATE, DELETE ON TONGHOP TO NV001 WITH GRANT OPTION;

CREATE OR REPLACE VIEW VW_TONGHOP_NAM
AS SELECT NAM FROM TONGHOP;
CREATE OR REPLACE VIEW VW_TONGHOP_THU
AS SELECT THU FROM TONGHOP;
CREATE OR REPLACE VIEW VW_TONGHOP_CHI
AS SELECT CHI FROM TONGHOP;

GRANT SELECT ON VW_TONGHOP_NAM TO NV001 WITH GRANT OPTION; 
GRANT SELECT ON VW_TONGHOP_CHI TO
NV001 WITH GRANT OPTION;
GRANT SELECT ON VW_TONGHOP_THU TO NV001 WITH GRANT OPTION;

-- CAP QUYEN CHO TRUONG PHONG
DECLARE
    CURSOR CUR IS (
        SELECT MANV
        FROM NHANVIEN
        WHERE CHUCVU = 'TRƯỞNG PHÒNG' AND MANV IN (
            SELECT USERNAME
            FROM ALL_USERS
        )
    );
    STRSQL NVARCHAR2(2000);
    USR NVARCHAR2(5);
BEGIN 
    OPEN CUR;
    STRSQL := 'ALTER SESSION SET "_ORACLE_SCRIPT" = TRUE' ;
    EXECUTE IMMEDIATE (STRSQL);
    LOOP
        FETCH CUR INTO USR;
        EXIT WHEN CUR%NOTFOUND;

        -- CAP QUYEN DOC GHI TREN BANG NHAN VIEN
        STRSQL := 'GRANT INSERT, UPDATE, DELETE ON NHANVIEN TO ' || USR || ' WITH GRANT OPTION';
        
        EXECUTE IMMEDIATE (STRSQL);

        STRSQL := 'GRANT SELECT ON NHANVIEN TO ' || USR ;
        EXECUTE IMMEDIATE(STRSQL) ; 

        -- CAP QUYEN DOC GHI TREN BANG LUONG
        STRSQL := 'GRANT INSERT, UPDATE, DELETE ON LUONG TO ' || USR || ' WITH GRANT OPTION';
        EXECUTE IMMEDIATE (STRSQL);

        STRSQL := 'GRANT SELECT ON LUONG TO ' || USR ;
        EXECUTE IMMEDIATE(STRSQL) ; 
    END LOOP;
    STRSQL := 'ALTER SESSION SET "_ORACLE_SCRIPT" = FALSE' ;
    EXECUTE IMMEDIATE (STRSQL) ;
    COMMIT;
    CLOSE CUR; 
END;
/

-- CAP QUYEN CHO NHAN VIEN

DECLARE
    CURSOR CUR IS (
        SELECT MANV FROM NHANVIEN
        WHERE CHUCVU = 'NHÂN VIÊN'
        AND MANV IN (
            SELECT USERNAME FROM ALL_USERS
            WHERE USERNAME LIKE 'NV0%'
        )
    );
    STRSQL NVARCHAR2(2000);
    USR NVARCHAR2(5) ;
BEGIN
    OPEN CUR;
    STRSQL := 'ALTER SESSION SET "_ORACLE_SCRIPT" = TRUE' ;
    EXECUTE IMMEDIATE(STRSQL);
    LOOP
        FETCH CUR INTO USR;
        EXIT WHEN CUR%NOTFOUND;
        STRSQL := 'GRANT SELECT ON NHANVIEN TO ' || USR;
        EXECUTE IMMEDIATE (STRSQL);
    END LOOP;
        STRSQL := 'ALTER SESSION SET "_ORACLE_SCRIPT" = FALSE ';
    EXECUTE IMMEDIATE(STRSQL);
    COMMIT;
    CLOSE CUR;
END;
/

DISCONNECT;